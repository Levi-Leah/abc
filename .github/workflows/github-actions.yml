name: CI/CD for Node.js App on AKS
on:
  push:
    branches:
    - main # Run CI/CD when code is merged into the main branch

# For Azure auth for Bash script
permissions:
  contents: read
  id-token: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'latest'

    - name: Install npm
      run: npm install
      working-directory: ./app

    - name: Install kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 'latest'

    - name: Terraform Init
      run: terraform init
      working-directory: ./terraform-config

    - name: Azure CLI Login
      uses: Azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Terraform Plan
      run: terraform plan
      working-directory: ./terraform-config

    - name: Terraform Apply
      run: |
        terraform apply -auto-approve
        mkdir -p ~/.kube
        echo "${{ steps.terraform.outputs.kube_config }}" > ~/.kube/config
        chmod 600 ~/.kube/config
      working-directory: ./terraform-config

    - name: Install Helm
      uses: azure/setup-helm@v4.2.0
      with:
        version: 'latest'

    - name: Deploy using Helm
      run: |
        helm upgrade --install myapp ./helm-config
        kubectl get pods --namespace default

    - name: Verify Application
      run: |
        kubectl get services
        kubectl get pods
